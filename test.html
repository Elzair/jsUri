<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
    <title>juribuilder tests</title>
    <script type="text/javascript" src="juribuilder.js"></script>
    <script type="text/javascript" src="jsunit/app/jsUnitCore.js"></script>
    <script type="text/javascript">

        // any quasi-valid uri should survive parsing and re-stringification
        function _testSimpleUri(s) {
            var uri = new juribuilder(s);
            assertEquals('Explicitly calling toString() should match the original uri', s, uri.toString());
        }

        function testSimpleRelativeUri() { _testSimpleUri(''); }
        function testSimpleRelativeUri() { _testSimpleUri('/'); }
        function testSimpleRelativeDirectoryUri() { _testSimpleUri('tutorial1/'); }
        function testSimpleRelativeDirectory2Uri() { _testSimpleUri('/experts/'); }
        function testSimpleRelativeWithFilenameUri() { _testSimpleUri('/index.html'); }
        function testSimpleRelativeWithDirectoryAndFilenameUri() { _testSimpleUri('tutorial1/2.html'); }
        function testSimpleRelativeParentDirectoryUri() { _testSimpleUri('../'); }
        function testSimpleRelativeSiblingDirectoryUri() { _testSimpleUri('../experts/'); }
        function testSimpleRelativeGreatGrandparentDirectoryUri() { _testSimpleUri('../../../'); }
        function testSimpleRelativeCurrentDirectoryUri() { _testSimpleUri('./'); }
        function testSimpleRelativeCurrentDirectorySiblingDocUri() { _testSimpleUri('./test.html'); }
        function testSimpleDomain() { _testSimpleUri('www.test.com'); }
        function testSimpleAbsoluteUri() { _testSimpleUri('http://www.test.com/index.html'); }
        function testSimpleHttpsUri() { _testSimpleUri('http://www.test.com/index.html'); }
        function testSimpleCustomPortUri() { _testSimpleUri('http://www.test.com:8080/index.html'); }
        function testSimpleHttpsCustomPortUri() { _testSimpleUri('https://www.test.com:43443'); }
        function testSimpleRelativeWithAnchorUri() { _testSimpleUri('/index.html#content'); }
        function testSimpleAbsoluteWithAnchorUri() { _testSimpleUri('http://www.test.com/index.html#content'); }
        function testSimpleRelativeWithParamsUri() { _testSimpleUri('/index.html?a=1&b=2'); }
        function testSimpleAbsoluteWithParamsUri() { _testSimpleUri('http://www.test.com/index.html?a=1&b=2'); }
        function testSimpleAbsoluteWithParamsAndAnchorUri() { _testSimpleUri('http://www.test.com/index.html?a=1&b=2#content'); }
        function testSimpleWithMultipleParamValuesUri() { _testSimpleUri('http://www.test.com/index.html?arr=1&arr=2&arr=3&arr=3&b=2'); }
        function testSimpleWithBlankParamValuesUri() { _testSimpleUri('http://www.test.com/index.html?arr=1&arr=&arr=2'); }
        function testSimpleWithoutSchemeUri() { _testSimpleUri('//www.test.com/'); }

        /*
            uri manipulation tests
        */

        function testReplacingProtocol() {
            var u = new juribuilder('http://www.test.com/index.html?arr=1&arr=&arr=2');
            u.protocol = 'https';
            assertEquals('Protocol should switch to https', 'https://www.test.com/index.html?arr=1&arr=&arr=2', u.toString());
        }

        function testReplacingProtocolWithColon() {
            var u = new juribuilder('http://www.test.com/index.html?arr=1&arr=&arr=2');
            u.protocol = 'https:';
            assertEquals('There should not be a double colon', 'https://www.test.com/index.html?arr=1&arr=&arr=2', u.toString());
        }

        function testDisablingHasAuthorityPrefix() {
            var u = new juribuilder('//test.com/index.html');
            u.hasAuthorityPrefix = false;
            assertEquals('The authority prefix slashes (//) should be removed', 'test.com/index.html', u.toString());
        }

        function testDeletingProtocolKeepsAuthorityPrefix() {
            var u = new juribuilder('https://test.com/index.html');
            u.protocol = null;
            assertEquals('Authority prefix (//) slashes should remain intact', '//test.com/index.html', u.toString());
        }

        function testDeletingProtocolAndHasAuthorityPrefix() {
            var u = new juribuilder('https://test.com/index.html');
            u.protocol = null;
            u.hasAuthorityPrefix = false;
            assertEquals('Authority prefix (//) slashes should be suppressed', 'test.com/index.html', u.toString());
        }

        function testDisablingHasAuthorityPrefixWithProtocolConflict() {
            var u = new juribuilder('http://www.test.com/');
            u.hasAuthorityPrefix = false;
            assertEquals('Authority prefix (//) slashes should remain intact', 'http://www.test.com/', u.toString());
        }

        function testDisablingProtocolAndHasAuthorityPrefix() {
            var u = new juribuilder('http://www.test.com/');
            u.protocol = null;
            u.hasAuthorityPrefix = false;
            assertEquals('Authority prefix should remain intact', 'www.test.com/', u.toString());
        }

        function testAddingUserInfo() {
            var u = new juribuilder('https://test.com/index.html');
            u.userInfo = 'username:password';
            assertEquals('The dummy login information should be included in the uri', 'https://username:password@test.com/index.html', u.toString());
        }

        function testAddingUserInfoWithTrailing() {
            var u = new juribuilder('https://test.com/index.html');
            u.userInfo = 'username:password@';
            assertEquals('The superfluous trailing symbol should be stripped', 'https://username:password@test.com/index.html', u.toString());
        }

        function testAddingHostnameRelative() {
            var u = new juribuilder('/index.html');
            u.host = 'wherever.com';
            assertEquals('The hostname should be added to the uri', 'wherever.com/index.html', u.toString());
        }

        function testChangingHostnameRelative() {
            var u = new juribuilder('test.com/index.html');
            u.host = 'wherever.com';
            assertEquals('The hostname should be added to the uri', 'wherever.com/index.html', u.toString());
        }

        function testChangingHostnameAbsolute() {
            var u = new juribuilder('http://test.com/index.html');
            u.host = 'wherever.com';
            assertEquals('The hostname should be changed to whatever.com', 'http://wherever.com/index.html', u.toString());
        }

        function testAddingPortRelativeWithoutHost() {
            var u = new juribuilder('/index.html');
            u.port = 8080;
            assertEquals('The port will not show without a host', '/index.html', u.toString());
        }

        function testAddingPortAndHostRelative() {
            var u = new juribuilder('/index.html');
            u.port = 8080;
            u.host = 'test.com';
            assertEquals('The port will not show without a host', 'test.com:8080/index.html', u.toString());
        }

        function testChangingPortRelative() {
            var u = new juribuilder('test.com:80/index.html');
            u.port = 8080;
            assertEquals('The port should be changed to 8080', 'test.com:8080/index.html', u.toString());
        }

        function testChangingPortAbsolute() {
            var u = new juribuilder('http://test.com/index.html');
            u.port = 8080;
            assertEquals('The hostname should be changed to whatever.com', 'http://test.com:8080/index.html', u.toString());
        }

        function testAddingAPath() {
            var u = new juribuilder('www.test.com');
            u.path = '/some/article.html';
            assertEquals('The path should be appended to the uri', 'www.test.com/some/article.html', u.toString());
        }
        
        function testChangingPath() {
            var u = new juribuilder('http://www.test.com/news/latest.html');
            u.path = '/contact-us.html';
            assertEquals('The path be changed', 'http://www.test.com/contact-us.html', u.toString());
        }

        function testNullifyingPath() {
            var u = new juribuilder('http://www.test.com/news/latest.html');
            u.path = null;
            assertEquals('The path be removed', 'http://www.test.com', u.toString());
        }

        function testEmptyPath() {
            var u = new juribuilder('http://www.test.com/news/latest.html');
            u.path = '';
            assertEquals('The path be removed', 'http://www.test.com', u.toString());
        }

        function testAddingAQueryToNothing() {
            var u = new juribuilder('');
            u.query = 'this=that&something=else';
            assertEquals('The query string, question mark and slash should all be added to the url', '?this=that&something=else', u.toString());
        }

        function testAddingAQueryToARelativePath() {
            var u = new juribuilder('/some/file.html');
            u.query = 'this=that&something=else';
            assertEquals('The query string, question mark and slash should all be added to the url', '/some/file.html?this=that&something=else', u.toString());
        }

        function testAddingAQueryToADomain() {
            var u = new juribuilder('www.test.com');
            u.query = 'this=that&something=else';
            assertEquals('The query string, question mark and slash should all be added to the url', 'www.test.com/?this=that&something=else', u.toString());
        }

        function testSwappingQuery() {
            var u = new juribuilder('www.test.com?this=that&a=1&b=2;c=3');
            u.query = 'one=1&two=2';
            assertEquals('The query string should be replaced', 'www.test.com/?one=1&two=2', u.toString());
        }

        function testNullifyingQuery() {
            var u = new juribuilder('www.test.com?this=that&a=1&b=2;c=3');
            u.query = null;
            assertEquals('The query string and path placeholder should be removed', 'www.test.com', u.toString());
        }

        function testEmptyingQuery() {
            var u = new juribuilder('www.test.com?this=that&a=1&b=2;c=3');
            u.query = '';
            assertEquals('The query string and path placeholder should be removed', 'www.test.com', u.toString());
        }

        function testAddingAnchorToDomain() {
            var u = new juribuilder('www.test.com');
            u.anchor = 'content';
            assertEquals('The anchor and path placeholder should be added', 'www.test.com/#content', u.toString());
        }

        function testAddingAnchorWithHash() {
            var u = new juribuilder('www.test.com');
            u.anchor = '#content';
            assertEquals('The anchor and path placeholder should be added but no double hash', 'www.test.com/#content', u.toString());
        }

        function testAddingAnchorToPath() {
            var u = new juribuilder('a/b/c/123.html');
            u.anchor = 'content';
            assertEquals('The anchor should be added', 'a/b/c/123.html#content', u.toString());
        }

        function testChangingAnchor() {
            var u = new juribuilder('a/b/c/123.html#content');
            u.anchor = 'footer';
            assertEquals('The anchor should be changed', 'a/b/c/123.html#footer', u.toString());
        }

        function testEmptyingAnchor() {
            var u = new juribuilder('a/b/c/123.html#content');
            u.anchor = '';
            assertEquals('The anchor should be removed', 'a/b/c/123.html', u.toString());
        }

        
        /*
            fluent setters test
        */

        function testFluentAddition() {
            var u = new juribuilder('www.yahoo.com');
            u.setPath('/index.html').setAnchor('content');
            assertEquals('The uri should now contain path and anchor elements', 'www.yahoo.com/index.html#content', u.toString());
        }

        function testFluentReplacement() {
            var u = new juribuilder('http://www.test.com');
            u.setHost('www.yahoo.com').setProtocol('https');
            assertEquals('The uri should have been properly updated', 'https://www.yahoo.com', u.toString());
        }

        function testFluentConstruction() {
            var u = new juribuilder('')
                .setPath('/index.html')
                .setAnchor('content')
                .setHost('www.test.com')
                .setPort(8080)
                .setUserInfo('username:password')
                .setProtocol('https')
                .setQuery('this=that&some=thing');

            assertEquals('The uri should now contain all elements', 'https://username:password@www.test.com:8080/index.html?this=that&some=thing#content', u.toString());
        }

        function testFluentDestruction() {
            var u = new juribuilder('https://username:password@www.test.com:8080/index.html?this=that&some=thing#content')
                .setPath(null)
                .setAnchor(null)
                .setHost(null)
                .setPort(null)
                .setUserInfo(null)
                .setProtocol(null)
                .setQuery(null);

            assertEquals('The uri should now be empty', '', u.toString());
        }

        function testHostQuerySeparator() {
            var u = new juribuilder('www.test.com?q=search');
            assertEquals('Uri should contain a separator slash', 'www.test.com/?q=search', u.toString());
        }

        
        /*
            query string manipulation tests
        */

        function testDeleteParamName() {
            var u = new juribuilder('test.com?a=1&b=2&c=3&a=eh');
            u.query.deleteParam('b');
            assertEquals('The query string should not contain the b=2 param', 'test.com/?a=1&c=3&a=eh', u.toString());
        }

        function testDeleteParamNameValue() {
            var u = new juribuilder('test.com?a=1&b=2&c=3&a=eh');
            u.query.deleteParam('a', 'eh');
            assertEquals('The query string should not contain the a=eh param', 'test.com/?a=1&b=2&c=3', u.toString());
        }

        function testAddNullParam() {
            var u = new juribuilder('?a=1&b=2&c=3');
            u.query.addParam('d');
            assertEquals('The query string should not contain the null d= param', '?a=1&b=2&c=3&d=', u.toString());
        }

        function testAddKVPParam() {
            var u = new juribuilder('?a=1&b=2&c=3');
            u.query.addParam('d', '4');
            assertEquals('The query string should not contain the d=4 param', '?a=1&b=2&c=3&d=4', u.toString());
        }

        function testPrependKVPParam() {
            var u = new juribuilder('?a=1&b=2&c=3');
            u.query.addParam('d', '4', 0);
            assertEquals('The query string should not contain the d=4 param at the beginning', '?d=4&a=1&b=2&c=3', u.toString());
        }

        function testReplaceParamLongform() {
            var u = new juribuilder('?a=1&b=2&c=3');
            u.query.deleteParam('a').addParam('a', 'eh');
            assertEquals('The query string should contain a=eh at the end', '?b=2&c=3&a=eh', u.toString());
        }

        function testReplaceParamShortform() {
            var u = new juribuilder('?a=1&b=2&c=3');
            u.query.replaceParam('a', 'eh');
            assertEquals('The query param named a should be modified in place', '?a=eh&b=2&c=3', u.toString());
        }

        function testReplaceParamValueShortform() {
            var u = new juribuilder('?a=1&b=2&c=3&c=4&c=5&c=6');
            u.query.replaceParam('c', 'five', '5');
            assertEquals('The query param pair c=5 should be replaced by c=five', '?a=1&b=2&c=3&c=4&c=five&c=6', u.toString());
        }


        /*
            path manipulation tests
        */

    </script>
</head>
<body>
    <p>
        <a href="jsunit/testRunner.html?testPage=" id="testLink">Click here</a> to launch the JsUnit Test Runner.
    </p>
    <script type="text/javascript">
        var testLink = document.getElementById('testLink');
        testLink.href = testLink.href + window.location;
    </script>
</body>
</html>